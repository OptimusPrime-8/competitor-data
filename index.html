<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CompeteBase | Market Intelligence</title>
    
    <!-- LIBRARIES -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@3.0.0/dist/chartjs-chart-treemap.min.js"></script>

    <style>
        /* SAME STYLING AS ADMIN, BUT REMOVING DANGER COLORS */
        :root {
            --primary: #0f172a; --secondary: #334155; --accent: #0ea5e9;
            --bg: #f8fafc; --surface: #ffffff; --border: #e2e8f0; --text-main: #1e293b;
            --text-light: #64748b; 
            --c1: #3b82f6; --c2: #10b981; --c3: #f59e0b; --c4: #ef4444; 
            --c5: #8b5cf6; --c6: #ec4899; --c7: #06b6d4; --c8: #84cc16;
            --aquarium-grad: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
            --chat-header: linear-gradient(135deg, #0ea5e9, #6366f1);
        }

        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        .navbar { height: 65px; background: var(--surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 24px; gap: 20px; z-index: 50; box-shadow: 0 2px 4px rgba(0,0,0,0.03); flex-shrink: 0; }
        .logo { font-family: 'Outfit', sans-serif; font-size: 22px; font-weight: 800; text-decoration: none; background: linear-gradient(to right, #06b6d4, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: flex; align-items: center; gap: 8px; }
        
        .tabs { display: flex; gap: 5px; background: #e2e8f0; padding: 4px; border-radius: 8px; margin-left: 40px; }
        .tab { padding: 6px 16px; font-size: 13px; font-weight: 600; cursor: pointer; border-radius: 6px; color: var(--text-light); transition: 0.2s; user-select: none; }
        .tab.active { background: white; color: var(--accent); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        .nav-actions { display: flex; gap: 10px; margin-left: auto; }
        .btn { padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; border: 1px solid transparent; display: flex; align-items: center; gap: 8px; transition: 0.2s; white-space: nowrap; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-outline { border-color: var(--border); background: white; color: var(--text-main); }
        
        .layout { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 260px; background: white; border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; padding: 20px; flex-shrink: 0; }
        .main { flex: 1; padding: 24px; overflow-y: auto; overflow-x: hidden; background: var(--bg); position: relative; }
        
        .filter-group { margin-bottom: 15px; }
        .filter-label { font-size: 11px; font-weight: 700; color: var(--text-light); text-transform: uppercase; margin-bottom: 6px; display: block; }
        .sidebar-select { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 12px; background: #f8fafc; outline: none; }
        .range-inputs { display: flex; gap: 8px; }
        .range-input { width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; }

        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .toolbar { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .search-input { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; width: 300px; font-size: 13px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .table-container { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        table { width: 100%; border-collapse: collapse; }
        .main-table th { background: #f1f5f9; text-align: left; padding: 14px 16px; font-size: 12px; font-weight: 700; color: var(--secondary); text-transform: uppercase; border-bottom: 2px solid #e2e8f0; cursor: pointer; user-select: none; }
        .main-table th:hover { background: #e2e8f0; color: var(--accent); }
        .main-table td { padding: 12px 16px; border-bottom: 1px solid var(--border); font-size: 13px; vertical-align: middle; }
        .main-table tr:hover { background: #f8fafc; }

        .badge { padding: 3px 8px; border-radius: 20px; font-size: 11px; font-weight: 600; display: inline-block; }
        .badge-na { background: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; } 
        .badge-eu { background: #dcfce7; color: #15803d; border: 1px solid #bbf7d0; } 
        .badge-as { background: #fef9c3; color: #a16207; border: 1px solid #fde047; }
        .product-tag { display: inline-block; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin: 2px; font-weight: 600; box-shadow: 0 1px 1px rgba(0,0,0,0.05); }

        .analytics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding-bottom: 40px; }
        .chart-card { background: white; padding: 15px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.03); display: flex; flex-direction: column; height: 320px; }
        .chart-card.wide { grid-column: span 2; }
        .chart-header { font-size: 13px; font-weight: 700; color: var(--secondary); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #f1f5f9; padding-bottom: 8px; }
        .chart-body { flex: 1; position: relative; width: 100%; min-height: 0; overflow: hidden; display:flex; justify-content:center; }

        .compare-view { position: fixed; inset: 0; background: #f0f4f8; z-index: 150; display: none; flex-direction: column; }
        .compare-view.open { display: flex; }
        .comp-header { padding: 15px 30px; background: white; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); z-index: 20; }
        .comp-table-wrapper { flex: 1; overflow: auto; padding: 30px; }
        .comp-table { width: 100%; border-collapse: separate; border-spacing: 0; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1); table-layout: fixed; }
        .comp-table th { background: var(--aquarium-grad); color: white; position: sticky; top: 0; z-index: 30; padding: 20px; min-width: 240px; text-align: left; border-right: 1px solid rgba(255,255,255,0.1); }
        .comp-table th:first-child { position: sticky; left: 0; z-index: 40; background: linear-gradient(135deg, #0891b2, #0284c7); border-right: 1px solid rgba(255,255,255,0.2); width: 220px; }
        .comp-cat-row td { font-weight: 800; text-transform: uppercase; padding: 12px 20px; border-bottom: 1px solid #cbd5e1; font-size: 11px; letter-spacing: 1px; position: sticky; left: 0; z-index: 25; background: #f8fafc; color: #64748b; border-left: 5px solid #94a3b8; }
        .comp-table td { padding: 14px 20px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #f1f5f9; vertical-align: top; font-size: 12px; line-height: 1.5; background: white; color: var(--text-main); }
        .comp-table td:first-child { position: sticky; left: 0; z-index: 10; background: #ffffff; font-weight: 700; border-right: 2px solid #e2e8f0; width: 220px; box-shadow: 2px 0 5px rgba(0,0,0,0.05); color: var(--secondary); }
        .remove-col-btn { color: rgba(255,255,255,0.7); background: rgba(255,255,255,0.1); border: none; cursor: pointer; width: 24px; height: 24px; border-radius: 4px; float: right; transition: 0.2s; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .remove-col-btn:hover { background: #ef4444; color: white; }
        .bg-c1 { background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; } .bg-c2 { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; } .bg-c3 { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; } .bg-c4 { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; } .bg-c5 { background: #f3e8ff; color: #6b21a8; border: 1px solid #e9d5ff; } .bg-c6 { background: #fce7f3; color: #9d174d; border: 1px solid #fbcfe8; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-box { background: white; width: 450px; padding: 30px; border-radius: 16px; max-height: 80vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .drawer { position: fixed; top: 0; right: -650px; width: 650px; bottom: 0; background: white; z-index: 100; transition: right 0.3s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: -10px 0 40px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .drawer.open { right: 0; }
        .drawer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 90; display: none; }
        .fab-compare { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 12px 28px; border-radius: 50px; font-weight: 600; cursor: pointer; box-shadow: 0 10px 25px rgba(15, 23, 42, 0.3); display: none; align-items: center; gap: 12px; z-index: 80; animation: bounceIn 0.3s; }
        @keyframes bounceIn { from { transform: translate(-50%, 20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
    </style>
</head>
<body>

    <!-- NAVBAR: CLEAN, NO UPLOAD BUTTONS -->
    <div class="navbar">
        <a href="#" class="logo">
            <i class="fa-solid fa-layer-group"></i> CompeteBase
        </a>
        
        <div class="tabs">
            <div class="tab active" onclick="switchView('list')">Companies</div>
            <div class="tab" onclick="switchView('analytics')">Market Analytics</div>
        </div>

        <div class="nav-actions">
            <!-- EXPORT IS ALLOWED -->
            <button class="btn btn-accent" onclick="initDownload('selection')">
                <i class="fa-solid fa-download"></i> Export Report
            </button>
        </div>
    </div>

    <div class="layout">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <h3 style="margin-top:0; font-size:13px; border-bottom:1px solid #eee; padding-bottom:10px; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px;">Filters</h3>
            <div class="filter-group"><label class="filter-label">Region</label><select id="f-region" class="sidebar-select" onchange="updateCountryFilter()"><option value="All">All Regions</option></select></div>
            <div class="filter-group"><label class="filter-label">Country</label><select id="f-country" class="sidebar-select" onchange="applyFilters()"><option value="All">All Countries</option></select></div>
            <div class="filter-group"><label class="filter-label">Core Product</label><select id="f-core" class="sidebar-select" onchange="applyFilters()"><option value="All">All Products</option></select></div>
            <div class="filter-group"><label class="filter-label">Employee Range</label><div class="range-inputs"><input type="number" id="f-emp-min" placeholder="Min" class="range-input" onkeyup="applyFilters()"><input type="number" id="f-emp-max" placeholder="Max" class="range-input" onkeyup="applyFilters()"></div></div>
            <div class="filter-group"><label class="filter-label">Revenue Range ($M)</label><div class="range-inputs"><input type="number" id="f-rev-min" placeholder="Min" class="range-input" onkeyup="applyFilters()"><input type="number" id="f-rev-max" placeholder="Max" class="range-input" onkeyup="applyFilters()"></div></div>
            <button class="btn btn-outline" style="width:100%; justify-content:center; margin-top:20px;" onclick="resetFilters()"><i class="fa-solid fa-rotate-left"></i> Reset</button>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main">
            <!-- VIEW 1: HOME LIST -->
            <div id="list" class="view-section active">
                <div class="toolbar">
                    <input type="text" id="globalSearch" class="search-input" placeholder="Search companies..." onkeyup="applyFilters()">
                    <div style="font-size:13px; color:var(--text-light); padding-top:8px;">Showing <b id="count-display" style="color:var(--text-main);">0</b> results</div>
                </div>
                <div class="table-container">
                    <table class="main-table">
                        <thead>
                            <tr>
                                <th width="40"><input type="checkbox" id="selectAllBox" onclick="toggleSelectAll(this)"></th>
                                <th onclick="sortDB('id')">ID <i class="fa-solid fa-sort"></i></th>
                                <th onclick="sortDB('name')">Company <i class="fa-solid fa-sort"></i></th>
                                <th onclick="sortDB('region')">Region <i class="fa-solid fa-sort"></i></th>
                                <th>Core Products</th>
                                <th onclick="sortDB('industry')">Industry <i class="fa-solid fa-sort"></i></th>
                                <th onclick="sortDB('employees')">Employees <i class="fa-solid fa-sort"></i></th>
                                <th onclick="sortDB('revenue')">Revenue <i class="fa-solid fa-sort"></i></th>
                                <th width="80">Action</th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                    <div id="empty-state" style="padding:60px; text-align:center; display:none; color:var(--text-light);">
                        <i class="fa-solid fa-circle-notch fa-spin" style="font-size:40px; margin-bottom:15px; color:var(--accent);"></i>
                        <p>Loading market data...</p>
                    </div>
                </div>
            </div>

            <!-- VIEW 2: ANALYTICS -->
            <div id="analytics" class="view-section">
                <div class="analytics-grid">
                    <div class="chart-card"><div class="chart-header">Regional Distribution</div><div class="chart-body"><canvas id="chartRegion"></canvas></div></div>
                    <div class="chart-card"><div class="chart-header">Revenue by Company ($M)</div><div class="chart-body"><canvas id="chartRevenue"></canvas></div></div>
                    <div class="chart-card"><div class="chart-header">Type of Company</div><div class="chart-body"><canvas id="chartType"></canvas></div></div>
                    <div class="chart-card"><div class="chart-header">Employees Count</div><div class="chart-body"><canvas id="chartEmployees"></canvas></div></div>
                    <div class="chart-card"><div class="chart-header">Distributors Count</div><div class="chart-body"><canvas id="chartDistributors"></canvas></div></div>
                    <div class="chart-card"><div class="chart-header">Warehouses Count</div><div class="chart-body"><canvas id="chartWarehouses"></canvas></div></div>
                    <div class="chart-card"><div class="chart-header">Current Products (Count)</div><div class="chart-body"><canvas id="chartCurProd"></canvas></div></div>
                    <div class="chart-card"><div class="chart-header">Discontinued Products</div><div class="chart-body"><canvas id="chartDiscProd"></canvas></div></div>
                    <div class="chart-card wide"><div class="chart-header">Core Products Matrix (Presence)</div><div class="chart-body"><canvas id="chartCoreMatrix"></canvas></div></div>
                    <div class="chart-card wide"><div class="chart-header">Market Revenue Share</div><div class="chart-body"><canvas id="chartRevTreemap"></canvas></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- FLOATING COMPARE -->
    <div class="fab-compare" id="compareFab" onclick="openCompareView()"><i class="fa-solid fa-scale-balanced"></i> Compare (<span id="compCount">0</span>)</div>

    <!-- DETAILS DRAWER -->
    <div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>
    <div class="drawer" id="detailsDrawer">
        <div style="padding:25px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
            <div><h2 id="d-name" style="margin:0; color:var(--primary);">Company</h2><div id="d-meta" style="font-size:12px; color:var(--text-light); margin-top:4px;"></div></div>
            <button class="btn btn-outline" onclick="closeDrawer()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="d-content" style="padding:25px; overflow-y:auto; background:#f8fafc; height:100%;"></div>
    </div>

    <!-- COMPARISON VIEW -->
    <div class="compare-view" id="compareView">
        <div class="comp-header">
            <h3 style="margin:0; color:var(--primary); display:flex; align-items:center; gap:10px;"><i class="fa-solid fa-scale-balanced" style="color:var(--accent);"></i> Head-to-Head</h3>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-outline" onclick="openAddModal()"><i class="fa-solid fa-plus"></i> Add</button>
                <button class="btn btn-accent" onclick="initDownload('comparison')"><i class="fa-solid fa-download"></i> Export</button>
                <button class="btn btn-primary" onclick="document.getElementById('compareView').classList.remove('open')">Close</button>
            </div>
        </div>
        <div class="comp-table-wrapper"><table class="comp-table" id="compTable"></table></div>
    </div>

    <!-- MODALS -->
    <div class="modal" id="addModal"><div class="modal-box"><h3 style="margin-top:0;">Add to Comparison</h3><input type="text" id="addSearch" class="search-input" style="width:100%; margin-bottom:15px;" placeholder="Search..." onkeyup="renderAddList()"><div id="add-list" style="max-height:300px; overflow-y:auto; border:1px solid #eee; border-radius:8px;"></div><button class="btn btn-outline" style="width:100%; margin-top:15px;" onclick="document.getElementById('addModal').style.display='none'">Cancel</button></div></div>
    <div class="modal" id="dlModal"><div class="modal-box" style="text-align:center;"><h3 style="margin-top:0;">Export Data</h3><p style="color:#64748b; font-size:13px;">Choose format:</p><div style="display:flex; justify-content:center; gap:20px; margin-top:25px;"><button class="btn btn-outline" onclick="executeDownload('pdf')" style="flex-direction:column; padding:25px; width:120px;"><i class="fa-regular fa-file-pdf" style="font-size:28px; margin-bottom:10px; color:#ef4444;"></i>PDF Report</button><button class="btn btn-outline" onclick="executeDownload('excel')" style="flex-direction:column; padding:25px; width:120px;"><i class="fa-regular fa-file-excel" style="font-size:28px; margin-bottom:10px; color:#10b981;"></i>Excel Data</button></div><button class="btn btn-primary" style="margin-top:25px; width:100%;" onclick="closeModal()">Close</button></div></div>

    <script>
        // --- HARDCODED CONFIG FOR VIEWERS ---
        const GITHUB_USERNAME = 'OptimusPrime-8'; // <--- MUST MATCH YOUR USERNAME
        const GITHUB_REPO = 'competitor-data';    // <--- MUST MATCH YOUR REPO
        const GITHUB_FILE = 'database.json';
        
        // --- GLOBAL VARIABLES ---
        let db = [], filteredDB = [], selectedIDs = new Set(), currentSort = { col: null, dir: 'asc' }, chartInstances = {};
        const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16', '#6366f1', '#14b8a6'];

        window.addEventListener('DOMContentLoaded', () => {
            fetchData();
        });

        async function fetchData() {
            // Fetch directly from Raw GitHub URL (Requires Public Repo)
            const url = `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${GITHUB_REPO}/main/${GITHUB_FILE}`;
            try {
                const response = await fetch(url);
                if(response.ok) {
                    db = await response.json();
                    filteredDB = [...db];
                    populateFilters();
                    applyFilters();
                    document.getElementById('empty-state').style.display = 'none';
                } else {
                    document.getElementById('empty-state').innerHTML = '<p>No data found or Repository is Private.</p>';
                }
            } catch(e) {
                console.error(e);
                document.getElementById('empty-state').innerHTML = '<p>Error loading market data.</p>';
            }
        }

        // --- UI LOGIC ---
        function populateFilters() {
            const regions = [...new Set(db.map(x => x.region))].sort(); fillSelect('f-region', regions); updateCountryFilter();
            const rawProds = db.map(x => x.coreProduct).filter(Boolean);
            const uniqueProds = [...new Set(rawProds.flatMap(p => p.split(',').map(s => s.trim())))].sort();
            fillSelect('f-core', uniqueProds);
        }
        function updateCountryFilter() {
            const r = document.getElementById('f-region').value; const available = r === 'All' ? db : db.filter(x => x.region === r);
            fillSelect('f-country', [...new Set(available.map(x => x.country))].sort()); applyFilters();
        }
        function fillSelect(id, items) {
            const sel = document.getElementById(id); const curr = sel.value;
            let lbl = id.includes('region') ? 'Regions' : id.includes('country') ? 'Countries' : 'Products';
            sel.innerHTML = `<option value="All">All ${lbl}</option>`;
            items.forEach(i => { if(i && i !== '-') sel.innerHTML += `<option value="${i}">${i}</option>`; });
            if(items.includes(curr)) sel.value = curr;
        }
        function applyFilters() {
            const reg = document.getElementById('f-region').value, cnt = document.getElementById('f-country').value, core = document.getElementById('f-core').value;
            const eMin = parseFloat(document.getElementById('f-emp-min').value)||0, eMax = parseFloat(document.getElementById('f-emp-max').value)||Infinity;
            const rMin = parseFloat(document.getElementById('f-rev-min').value)||0, rMax = parseFloat(document.getElementById('f-rev-max').value)||Infinity;
            const q = document.getElementById('globalSearch').value.toLowerCase();
            filteredDB = db.filter(c => {
                if(reg !== 'All' && c.region !== reg) return false;
                if(cnt !== 'All' && c.country !== cnt) return false;
                if(core !== 'All' && !c.coreProduct.toLowerCase().includes(core.toLowerCase())) return false;
                if(c.employees < eMin || c.employees > eMax) return false;
                if(c.revenue < rMin || c.revenue > rMax) return false;
                if(q && !JSON.stringify(c).toLowerCase().includes(q)) return false;
                return true;
            });
            document.getElementById('count-display').innerText = filteredDB.length;
            if(document.getElementById('list').classList.contains('active')) renderTable();
            if(document.getElementById('analytics').classList.contains('active')) renderAnalytics();
        }
        function resetFilters() { document.querySelectorAll('select').forEach(s => s.value='All'); document.querySelectorAll('input').forEach(i => i.value=''); populateFilters(); applyFilters(); }
        
        function renderTable() {
            const tbody = document.getElementById('table-body'); tbody.innerHTML = '';
            if(filteredDB.length === 0) return;
            filteredDB.forEach(c => {
                let rClass = c.region === 'North America' ? 'badge-na' : c.region === 'Europe' ? 'badge-eu' : 'badge-as';
                let pHtml = c.coreProduct && c.coreProduct !== '-' ? c.coreProduct.split(',').slice(0, 3).map((p,i) => `<span class="product-tag bg-c${(i%6)+1}">${p.trim()}</span>`).join('') : '-';
                const isChecked = selectedIDs.has(c.id) ? 'checked' : '';
                tbody.innerHTML += `<tr><td style="text-align:center;"><input type="checkbox" class="row-cb" value="${c.id}" onchange="toggleSelect('${c.id}')" ${isChecked}></td>
                    <td style="font-family:monospace; color:#64748b;">${c.id}</td><td style="font-weight:600; color:var(--primary);">${c.name}</td>
                    <td><span class="badge ${rClass}">${c.region}</span></td><td>${pHtml}</td><td>${c.industry}</td>
                    <td>${c.employees.toLocaleString()}</td><td>$${c.revenue.toLocaleString()}M</td>
                    <td><button class="btn btn-outline" style="padding:5px 10px; font-size:11px;" onclick="showDetails('${c.id}')">View</button></td></tr>`;
            });
            checkSelectAllBox();
        }

        function sortDB(col) {
            currentSort.dir = currentSort.col === col && currentSort.dir === 'asc' ? 'desc' : 'asc'; currentSort.col = col;
            filteredDB.sort((a,b) => { let vA=a[col],vB=b[col]; if(typeof vA==='string'){vA=vA.toLowerCase();vB=vB.toLowerCase();} return (vA<vB?-1:1)*(currentSort.dir==='asc'?1:-1); });
            renderTable();
        }

        // --- ANALYTICS (Identical to Admin) ---
        function renderAnalytics() {
            const createChart = (id, type, labels, data, labelStr, isDoughnut=false) => {
                const ctx = document.getElementById(id); if(chartInstances[id]) chartInstances[id].destroy();
                chartInstances[id] = new Chart(ctx, {
                    type: type, data: { labels: labels, datasets: [{ label: labelStr, data: data, backgroundColor: isDoughnut ? colors : colors.map((c,i)=>colors[i%colors.length]), borderRadius: type==='bar'?4:0 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: isDoughnut, position: isDoughnut ? 'bottom' : 'right' } }, scales: isDoughnut ? {} : { y: { beginAtZero: true } } }
                });
            };
            const labels = filteredDB.map(c => c.name);
            const regCounts = {}; filteredDB.forEach(c => { const r = c.rawRegion || c.region; regCounts[r] = (regCounts[r]||0)+1; });
            createChart('chartRegion', 'doughnut', Object.keys(regCounts), Object.values(regCounts), 'Companies', true);
            createChart('chartRevenue', 'bar', labels, filteredDB.map(c => c.revenue), 'Revenue ($M)');
            const typeCounts = { 'Public': 0, 'Private': 0 }; filteredDB.forEach(c => { if(c.type.toLowerCase().includes('public')) typeCounts['Public']++; else typeCounts['Private']++; });
            createChart('chartType', 'pie', Object.keys(typeCounts), Object.values(typeCounts), 'Count', true);
            createChart('chartEmployees', 'bar', labels, filteredDB.map(c => c.employees), 'Employees');
            createChart('chartDistributors', 'bar', labels, filteredDB.map(c => c.stats.distributors || 0), 'Distributors');
            createChart('chartWarehouses', 'bar', labels, filteredDB.map(c => c.stats.warehouses || 0), 'Warehouses');
            createChart('chartCurProd', 'pie', labels, filteredDB.map(c => c.stats.products || 0), 'Products', true);
            createChart('chartDiscProd', 'bar', labels, filteredDB.map(c => c.stats.discontinued || 0), 'Discontinued');
            
            const allProds = new Set();
            filteredDB.forEach(c => { if(c.coreProduct && c.coreProduct !== '-') c.coreProduct.split(',').forEach(p => allProds.add(p.trim())); });
            const uniqueProds = Array.from(allProds).sort();
            
            // Core Product Matrix
            const matrixData = [];
            filteredDB.forEach((c) => {
                const cProds = c.coreProduct ? c.coreProduct.split(',').map(s=>s.trim()) : [];
                uniqueProds.forEach((p) => { if(cProds.includes(p)) matrixData.push({ x: p, y: c.name, r: 8 }); });
            });
            const ctxMatrix = document.getElementById('chartCoreMatrix');
            if(chartInstances['chartCoreMatrix']) chartInstances['chartCoreMatrix'].destroy();
            chartInstances['chartCoreMatrix'] = new Chart(ctxMatrix, {
                type: 'bubble', data: { datasets: [{ label: 'Available', data: matrixData, backgroundColor: 'rgba(59, 130, 246, 0.7)', borderColor: '#3b82f6', borderWidth: 1 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'category', labels: uniqueProds, offset: true }, y: { type: 'category', labels: filteredDB.map(c=>c.name), offset: true } }, plugins: { legend: { display: false } } }
            });

            // Treemap Fixed
            const totalRev = filteredDB.reduce((sum, c) => sum + c.revenue, 0);
            const treemapData = filteredDB.map(c => ({ name: c.name, value: c.revenue })).filter(d => d.value > 0);
            const ctxTreemap = document.getElementById('chartRevTreemap');
            if(chartInstances['chartRevTreemap']) chartInstances['chartRevTreemap'].destroy();
            chartInstances['chartRevTreemap'] = new Chart(ctxTreemap, {
                type: 'treemap',
                data: { datasets: [{ tree: treemapData, key: 'value', groups: ['name'], backgroundColor: (ctx) => { if (ctx.type !== 'data') return 'transparent'; return colors[ctx.dataIndex % colors.length]; }, 
                labels: { display: true, formatter: (ctx) => { if (ctx.type !== 'data') return; const val = ctx.raw.v; let pct = totalRev > 0 ? Math.round((val / totalRev) * 100) : 0; let name = ctx.raw.g || "Unknown"; if(name.length > 15) name = name.substring(0, 12) + '...'; return [name, `$${val}M`, `${pct}%`]; }, color: 'white', font: { size: 11, weight: 'bold' } } }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        // --- OTHER UTILS ---
        function toggleSelectAll(source) { const isChecked = source.checked; filteredDB.forEach(c => { const cb = document.querySelector(`.row-cb[value="${c.id}"]`); if(cb) cb.checked = isChecked; if(isChecked) selectedIDs.add(c.id); else selectedIDs.delete(c.id); }); updateFab(); }
        function toggleSelect(id) { if (selectedIDs.has(id)) selectedIDs.delete(id); else selectedIDs.add(id); updateFab(); checkSelectAllBox(); }
        function checkSelectAllBox() { if (filteredDB.length === 0) { document.getElementById('selectAllBox').checked = false; return; } document.getElementById('selectAllBox').checked = filteredDB.every(c => selectedIDs.has(c.id)); }
        function updateFab() { document.getElementById('compCount').innerText = selectedIDs.size; document.getElementById('compareFab').style.display = selectedIDs.size > 0 ? 'flex' : 'none'; }
        
        // --- COMPARISON & DRAWER ---
        function getCatIcon(cat) { const c = cat.toLowerCase(); let icon = 'fa-layer-group'; if(c.includes('swot')) icon = 'fa-shield-halved'; else if(c.includes('finance')||c.includes('revenue')) icon = 'fa-coins'; else if(c.includes('hr')||c.includes('employ')) icon = 'fa-users'; else if(c.includes('product')||c.includes('core')) icon = 'fa-box-open'; else if(c.includes('general')||c.includes('overview')) icon = 'fa-chart-pie'; return `<i class="fa-solid ${icon}" style="margin-right:8px; opacity:0.8;"></i>`; }
        function openCompareView() {
            if(selectedIDs.size < 1) return alert("Select at least 1 company.");
            const comps = db.filter(c => selectedIDs.has(c.id));
            const table = document.getElementById('compTable'); const keyMap = {}; 
            comps.forEach(c => { c.data.forEach(d => { const ck = d.key.toLowerCase(); if(ck.includes('competitor') || ck === 'data point' || ck.length < 2) return; if(!keyMap[d.cat]) keyMap[d.cat] = new Set(); keyMap[d.cat].add(d.key); }); });
            let html = `<thead><tr><th style="border-top-left-radius:12px;">Data Point</th>`;
            comps.forEach((c, i) => { html += `<th style="${i === comps.length-1 ? 'border-top-right-radius:12px;' : ''}"><div style="display:flex; justify-content:space-between; align-items:flex-start;"><div><span class="comp-name">${c.name}</span><span class="comp-meta">${c.region}</span></div><button class="remove-col-btn" onclick="removeFromCompare('${c.id}')"><i class="fa-solid fa-xmark"></i></button></div></th>`; });
            html += `</tr></thead><tbody><tr class="comp-cat-row theme-1"><td colspan="${comps.length+1}">${getCatIcon('General')} OVERVIEW</td></tr>`;
            html += `<tr class="row-theme-1"><td>Region</td>${comps.map(c=>`<td><span class="badge ${c.region==='North America'?'badge-na':c.region==='Europe'?'badge-eu':'badge-as'}">${c.region}</span></td>`).join('')}</tr>`;
            html += `<tr class="row-theme-1"><td>Revenue</td>${comps.map(c=>`<td style="font-weight:700;">$${c.revenue.toLocaleString()}M</td>`).join('')}</tr>`;
            html += `<tr class="row-theme-1"><td>Employees</td>${comps.map(c=>`<td>${c.employees.toLocaleString()}</td>`).join('')}</tr>`;
            let themeIdx = 2; for(const [cat, keys] of Object.entries(keyMap)) { let currentTheme = `theme-${themeIdx}`; html += `<tr class="comp-cat-row ${currentTheme}"><td colspan="${comps.length+1}">${getCatIcon(cat)} ${cat}</td></tr>`; keys.forEach(k => { html += `<tr class="row-${currentTheme}"><td>${k}</td>`; comps.forEach(c => { const dp = c.data.find(d => d.cat === cat && d.key === k); html += `<td>${dp ? dp.val : '-'}</td>`; }); html += `</tr>`; }); themeIdx = (themeIdx % 3) + 1; }
            table.innerHTML = html + "</tbody>"; document.getElementById('compareView').classList.add('open');
        }
        function removeFromCompare(id) { toggleSelect(id); if(selectedIDs.size < 1) document.getElementById('compareView').classList.remove('open'); else openCompareView(); }
        function switchView(view) { document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active')); event.target.classList.add('active'); document.getElementById(view).classList.add('active'); if(view === 'analytics') renderAnalytics(); if(view === 'list') renderTable(); }
        
        function showDetails(id) { const c = db.find(x => x.id === id); if(!c) return; document.getElementById('d-name').innerText = c.name; document.getElementById('d-meta').innerText = `${c.region} | ${c.industry}`; let html = ``; const groups = {}; c.data.forEach(d => { if(!groups[d.cat]) groups[d.cat]=[]; groups[d.cat].push(d); }); for(const [cat, items] of Object.entries(groups)) { html += `<div style="background:white; padding:20px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:15px;"><h4 style="margin:0 0 15px 0; color:var(--accent); font-size:12px; text-transform:uppercase;">${cat}</h4>`; items.forEach(i => { html += `<div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:8px; border-bottom:1px dashed #f1f5f9; padding-bottom:5px;"><span style="font-weight:500; color:#475569;">${i.key}</span><span style="text-align:right; max-width:60%; color:#1e293b;">${i.val}</span></div>`; }); html += `</div>`; } document.getElementById('d-content').innerHTML = html; document.getElementById('drawerOverlay').style.display = 'block'; setTimeout(() => document.getElementById('detailsDrawer').classList.add('open'), 10); }
        function closeDrawer() { document.getElementById('detailsDrawer').classList.remove('open'); setTimeout(() => document.getElementById('drawerOverlay').style.display = 'none', 300); }
        function openAddModal() { document.getElementById('addModal').style.display = 'flex'; renderAddList(); }
        function closeModal() { document.getElementById('dlModal').style.display='none'; document.getElementById('addModal').style.display='none'; }
        function renderAddList() { const q = document.getElementById('addSearch').value.toLowerCase(), list = document.getElementById('add-list'); list.innerHTML = ''; const av = db.filter(c => !selectedIDs.has(c.id) && (c.name.toLowerCase().includes(q) || String(c.id).toLowerCase().includes(q))); if(av.length === 0) { list.innerHTML = '<div style="padding:15px; color:#999; text-align:center;">No companies found.</div>'; return; } av.forEach(c => { const d = document.createElement('div'); d.style.padding='12px'; d.style.borderBottom='1px solid #f1f5f9'; d.style.cursor='pointer'; d.innerHTML = `<span>${c.name}</span>`; d.onclick = () => { toggleSelect(c.id); openCompareView(); renderAddList(); }; list.appendChild(d); }); }
        
        // Export Logic
        function initDownload(t) { if(selectedIDs.size===0) return alert("Select companies."); document.getElementById('dlModal').style.display='flex'; }
        function executeDownload(f) { closeModal(); const targets = db.filter(c => selectedIDs.has(c.id)); const matrixData = buildExportMatrix(targets); if(f === 'pdf') { if(targets.length > 5) return alert("⚠️ PDF supports max 5 companies. Use Excel."); generatePDFMatrix(matrixData, targets.length); } else { generateExcelMatrix(matrixData); } }
        function buildExportMatrix(targets) { const headers = ['Category', 'Data Point', ...targets.map(c => c.name)]; const rows = []; rows.push(['General', 'Region', ...targets.map(c => c.region)]); rows.push(['General', 'Revenue', ...targets.map(c => `$${c.revenue}M`)]); rows.push(['General', 'Employees', ...targets.map(c => c.employees)]); const keyMap = {}; targets.forEach(c => { c.data.forEach(d => { if(!keyMap[d.cat]) keyMap[d.cat] = new Set(); keyMap[d.cat].add(d.key); }); }); for(const [cat, keys] of Object.entries(keyMap)) { keys.forEach(k => { const rowData = [cat, k]; targets.forEach(c => { const dp = c.data.find(d => d.cat === cat && d.key === k); rowData.push(dp ? dp.val : '-'); }); rows.push(rowData); }); } return { headers, rows }; }
        function generateExcelMatrix(data) { const wb = XLSX.utils.book_new(); const wsData = [data.headers, ...data.rows]; const ws = XLSX.utils.aoa_to_sheet(wsData); XLSX.utils.book_append_sheet(wb, ws, "Comparison"); XLSX.writeFile(wb, "Competitor_Comparison.xlsx"); }
        function generatePDFMatrix(data, count) { const { jsPDF } = window.jspdf; const doc = new jsPDF({ orientation: count > 3 ? 'landscape' : 'portrait' }); doc.setFontSize(16); doc.text("Competitor Analysis Report", 14, 20); doc.setFontSize(10); doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 26); doc.autoTable({ startY: 35, head: [data.headers], body: data.rows, theme: 'grid', headStyles: { fillColor: [59, 130, 246] }, styles: { fontSize: 8 } }); doc.save("Comparison.pdf"); }
    </script>
</body>
</html>